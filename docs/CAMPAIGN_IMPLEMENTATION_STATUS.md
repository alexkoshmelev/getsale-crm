# Статус реализации: Кампании холодного аутрича

Пошаговый чеклист: что сделано, что нет, что делать дальше по логике.

---

## Сделано

### Бэкенд
- [x] **Миграции БД** — `20250217000001_campaigns.ts`: таблицы campaigns, campaign_templates, campaign_sequences, campaign_participants, campaign_sends. `20250217100001_campaign_sequences_trigger_type.ts`: колонка trigger_type (delay | after_reply).
- [x] **Campaign Service** (порт 3012): CRUD кампаний, шаблоны, sequences (включая PATCH/DELETE шагов, trigger_type), start/pause, participants, stats. События campaign.created/started/paused в RabbitMQ.
- [x] **API Gateway** — прокси `/api/campaigns`, заголовки X-User-Id, X-Organization-Id.
- [x] **Docker** — campaign-service в docker-compose.yml, MESSAGING_SERVICE_URL.
- [x] **Worker отправки:** раз в минуту обработка campaign_participants с next_send_at <= now. **Расписание:** отправка только в рабочие часы (workingHours) и выбранные дни (daysOfWeek) в таймзоне кампании; при выходе за окно next_send_at сдвигается на 15 мин. **sendDelaySeconds:** пауза между отправками разным участникам. Поддержка trigger_type «after_reply». Расчёт next_send_at с учётом расписания (nextSendAtWithSchedule).
- [x] **Подписка на message.received:** при получении события — для участников с следующим шагом «сразу после ответа» (trigger_type = after_reply) выставляется next_send_at = NOW(); для остальных — status = 'replied'.
- [x] **Расширенные условия шага:** в worker загружаются `cs.conditions`, контакт (first_name, last_name, email, phone, telegram_id, company_name); функция `evaluateStepConditions` проверяет stopIfReplied, правила по полям контакта (equals/not_equals/contains/empty/not_empty), inPipelineStage и notInPipelineStage (запрос к таблице leads). При невыполнении условий шаг пропускается — participant переводится на следующий шаг без отправки и без записи в campaign_sends.

### Документация
- [x] **CAMPAIGN_COLD_OUTREACH.md** — архитектура, API, практики, фазы.
- [x] **CAMPAIGN_IMPLEMENTATION_STATUS.md** — этот файл.

### Фронтенд
- [x] Навигация: пункт «Кампании» в сайдбаре (иконка Send), breadcrumbs, i18n (ru/en), быстрый переход в Command Palette (⌘K).
- [x] API-клиент для campaigns (lib/api/campaigns.ts): CRUD кампаний, шаблоны, sequence steps (create/update/delete), агенты, пресеты, контакты для выбора.
- [x] Страница списка кампаний: список, создание (модалка с названием), удаление, переход в кампанию/в редактор последовательности.
- [x] Страница кампании: вкладки **Обзор**, **Аудитория**, **Последовательность**. Кнопки управления: **Запустить** / **Продолжить** (при паузе), **Приостановить**, **Остановить** (полная остановка → status completed).
- [x] **Вкладка «Аудитория» (упрощённый флоу):**
  - **1. Откуда брать контакты** — выбор источника: **База CRM** (фильтры: компания, воронка, только с Telegram; лимит; «Только новые»; кнопка «Выбрать из базы» + счётчик), **Файл (CSV)** (загрузка, счётчик), **Группа в Telegram** (выбор чата/канала, загрузка участников).
  - **2. Кто рассылает** — один BD-аккаунт (карточки с «X сегодня»).
  - **3. Расписание** — часовой пояс, задержка между отправками (сек), рабочие часы, дни недели.
  - **4. Дополнительно** (сворачиваемый блок) — создание лида в CRM (при первой отправке / при ответе / пропустить), воронка и стадия.
- [x] **Редактор последовательности (canvas):** вертикальный флоу шагов; drag-and-drop порядка; модалка шага: пресет, текст, триггер (задержка / после ответа), **расширенные условия** (блок «Условия отправки»: не слать если ответил; правила по полю контакта — поле, оператор, значение, несколько правил; «Отправлять только если в воронке X на этапе»; «Не отправлять, если в воронке X на этапе»), превью.

---

## Не сделано (по приоритету)

### Фронтенд (улучшения)
1. ~~Превью с «тестовым контактом»~~ — сделано.
2. ~~Расширенные условия шага (UI для contact, inPipelineStage, notInPipelineStage)~~ — сделано.

### Бэкенд
3. Статус campaign «completed» при завершении всех участников (опционально).
4. Rate limiting / throttle по каналу (Telegram) на уровне worker.

### AI (заглушки → полноценно)
5. В шаблоне: поддержка {{ai.personalize}} (заглушка → вызов AI позже).
6. Оптимальное время отправки (schedule + random offset; позже — модель).

---

## Что делать дальше (по порядку)

1. ~~Аудитория и расписание (вкладка, фильтры, лимит, расписание)~~ — **сделано**.
2. ~~Drag-and-drop порядка шагов в canvas~~ — **сделано**.
3. ~~Условия шага (stopIfReplied в модалке)~~ — **сделано**.
4. ~~Превью сообщения (выбор контакта, подстановка переменных)~~ — **сделано**.
5. ~~Worker отправки + message.received → replied~~ — **сделано**.
6. ~~Триггер шага «Сразу после ответа контакта» (trigger_type after_reply)~~ — **сделано**.
7. ~~Учёт расписания в worker + sendDelaySeconds~~ — **сделано**.
8. **Потом:** Полировка (rate limit по Telegram, статус campaign completed, тестовый контакт для превью).
9. **Позже:** AI-заглушки и полноценный AI (в т.ч. AI Rewrite в шаге).

### Реализовано по образцу референсного CRM (Task Manager / холодный аутрич)

- **Выбор агента (BD-аккаунт):** список активных аккаунтов с меткой «X сегодня» (сколько сообщений отправлено за день через кампании). Сохранение bdAccountId в target_audience; при старте кампании используется выбранный аккаунт или первый активный.
- **Тег контакта (new / in_outreach):** статус выводится из факта участия в любых кампаниях (campaign_participants). В пикере контактов — фильтры «Все» / «Новые» / «В аутриче» и колонка «Статус».
- **«Только новые» или точечный выбор:** галка «Только новые» (onlyNew) — при старте берутся только контакты, которые ещё не были в аутриче; кнопка «Выбрать из базы» открывает модалку с поиском, фильтрами и чекбоксами; выбранные contactIds сохраняются в target_audience и при старте используются только они.
- **Пресеты сообщений:** org-level шаблоны (campaign_templates с campaign_id = null). В модалке шага — выпадающий список «Выбрать пресет», кнопка «Сохранить как пресет». API: GET/POST /api/campaigns/presets.
- **Задержка между отправками (сек):** поле sendDelaySeconds в target_audience (UI есть; использование в worker — в бэклоге).
- **AI Rewrite:** заглушка в модалке шага (чекбокс «AI переписать (скоро)», неактивен).

### Идеи по образцу референсного CRM (что можно добавить)

- **Источник аудитории: CSV и группы** — реализовано. **Загрузка CSV:** POST /api/campaigns/:id/audience/from-csv (content, hasHeader); парсинг, поиск/создание контактов по telegram_id или email; возврат contactIds. **Группы из CRM:** GET /api/campaigns/group-sources (чаты/каналы из bd_account_sync_chats), GET /api/campaigns/group-sources/contacts?bdAccountId=&telegramChatId= (контакты по сообщениям в чате). На вкладке «Аудитория»: кнопка «Загрузить CSV», выбор «Из группы» (dropdown).
- **Настройки создания лида в CRM** — реализовано. Поле campaigns.lead_creation_settings: trigger (on_first_send | on_reply), default_stage_id. При первой отправке (worker) или при ответе (message.received) вызывается POST /api/pipeline/leads (pipeline-service). На вкладке «Аудитория»: блок «Создание лида в CRM» (когда создавать: при первой отправке / при ответе / пропустить), выбор воронки и стадии по умолчанию.
- **Динамические кампании:** реализовано. В аудитории кампании — блок «Динамическая кампания»: выбор воронки и этапов; при попадании лида в один из этапов (события lead.created / lead.stage.changed из pipeline-service) участник автоматически добавляется в кампанию. События публикуются в RabbitMQ; campaign-service подписан на них и добавляет запись в campaign_participants (с резолвом bd_account и channel по telegram_id контакта).

---

## Анализ конкурента (CRMChat) и бэклог

На основе статей конкурента ([поиск лидов](https://crmchat.ai/ru/telegram-lead-research), [подготовка базы](https://crmchat.ai/ru/help-center/preparing-telegram-prospect-database), [лучшие практики](https://crmchat.ai/ru/help-center/telegram-outreach-best-practices)) составлен документ **[COMPETITOR_CRMCHAT_ANALYSIS.md](./COMPETITOR_CRMCHAT_ANALYSIS.md)**. Кратко:

- **Уже есть:** аудитория из базы CRM, CSV, группа в Telegram (из синхронизированных чатов); sequence, шаблоны, расписание, создание лида в CRM.
- **Сделано по конкуренту:** чеклист «Перед запуском» (модалка при первом «Запустить»), подсказка у источника «Группа в Telegram», ссылка «Лучшие практики» на обзоре кампании (та же модалка).
- **Реализовано (февраль 2025):** динамические кампании (автодобавление по этапу лида), массовый импорт контактов в CRM из CSV (отдельно от аудитории кампании), рассылка одного сообщения в несколько групповых чатов Telegram, заметки и напоминания к контакту/сделке. Детали — в COMPETITOR_CRMCHAT_ANALYSIS.md.
- **В бэклоге:** поиск групп по ключевым словам, парсинг участников выбранной группы (getParticipants).
- **Лучшие практики** описаны в [OUTREACH_BEST_PRACTICES.md](./OUTREACH_BEST_PRACTICES.md); можно использовать в UI (модалка перед стартом, подсказки).

---

## Связь с другими документами

- **CAMPAIGN_COLD_OUTREACH.md** — полное описание механики и API.
- **COMPETITOR_CRMCHAT_ANALYSIS.md** — анализ CRMChat, сравнение, бэклог.
- **OUTREACH_BEST_PRACTICES.md** — чеклист и советы по рассылкам.
- **STATE_AND_ROADMAP.md** — общий статус продукта.
- **MASTER_PLAN_MESSAGING_FIRST_CRM.md** — бэклог.

После каждого этапа обновлять этот файл (отмечать выполненное, сдвигать «что делать дальше»).

---

## Что делать дальше

1. ~~**Полировка:** статус «completed», rate limit, превью с тестовым контактом~~ — реализовано (см. ниже).
2. ~~**Ответственный по умолчанию**~~ — реализовано: миграция `leads.responsible_id`, pipeline POST принимает `responsibleId`, в кампании в блоке «Создание лида» — выбор ответственного (из участников команды).
3. **Мультивыбор BD:** несколько BD-аккаунтов в рамках одной кампании (распределение участников по агентам) — в бэклоге.
4. ~~**Динамические кампании**~~ — реализовано (см. выше).
5. ~~**Напоминания: виджет «Предстоящие напоминания»**~~ — реализовано: GET /api/crm/reminders/upcoming, виджет на главной дашборда.
6. **Дальше (по приоритету):**
   - Push/email при наступлении времени напоминания (сейчас — только виджет).
   - Поиск групп по ключевым словам (Telegram API, ограничения).
   - Парсинг участников группы (getParticipants), экспорт контактов/лидов в CSV.
   - ~~Расширенные условия шага~~ — реализовано (см. CAMPAIGN_COLD_OUTREACH.md §3.5).

**Реализовано в этой итерации (полировка и напоминания):**
- **Rate limit по Telegram:** не более `CAMPAIGN_MAX_SENDS_PER_ACCOUNT_PER_DAY` (по умолчанию 40) сообщений в день на один BD-аккаунт; при превышении участник переносится на следующий день.
- **Статус кампании «completed»:** после каждого прохода воркера проверяется, все ли участники в статусе completed/replied/failed; если да — кампания переводится в completed.
- **Превью с тестовым контактом:** в модалке шага последовательности добавлен пункт «Тестовые данные (Иван Тестов)» для превью без выбора контакта из CRM.
- **Ответственный за лида:** поле `default_responsible_id` в настройках создания лида, передаётся в pipeline при создании лида; в БД лидов — колонка `responsible_id`.
- **Виджет «Предстоящие напоминания»:** на главной дашборда отображаются напоминания на ближайшие 72 ч со ссылками на контакт/сделку.

**Перед первым запуском после обновления:** выполнить миграции (`npm run migrate`), в т.ч. `20250210140001_leads_responsible_id.ts`.

---

## Ревью флоу запуска кампаний (UX)

Сценарий: пользователь создаёт кампанию и запускает её.

1. **Список кампаний** → «Новая кампания» → ввод названия → редирект на кампанию с вкладкой «Последовательность». Логично: сразу попадаем в редактор шагов.
2. **Вкладки:** Обзор, Аудитория, Участники, Последовательность. Кнопки Запустить / Приостановить / Остановить в шапке доступны всегда (для draft — Запустить). Порядок вкладок не подсказывает явный «чеклист» (сначала аудитория, потом последовательность), но это приемлемо: пользователь может настроить в любом порядке.
3. **Первый запуск:** показывается модалка «Перед запуском» (best practices); после «Понятно» — старт. Хорошо для новичков.
4. **Валидация перед стартом:** бэкенд при start формирует участников по target_audience и sequence. Если шагов нет или аудитория пуста — возможны «пустые» кампании или ошибка на бэке. Рекомендация: на фронте перед кнопкой «Запустить» показывать подсказки вида «Добавьте хотя бы один шаг», «Выберите аудиторию» (если steps.length === 0 или нет контактов/лимита), без блокировки кнопки — опционально.
5. **Расширенные условия шага:** в модалке шага блок «Условия отправки» с полями контакта, воронкой и этапами — всё в одном месте; multiselect этапов может быть непривычен (удобнее чекбоксы). Имеет смысл оставить как есть и при необходимости доработать по обратной связи.

**Итог:** флоу в целом в порядке. Улучшения по желанию: мягкие подсказки перед запуском (чеклист без жёсткой блокировки), при необходимости — доработка UX выбора этапов в условиях.

---

## Что делать дальше (рекомендации)

1. **Уведомления по напоминаниям** — push или email при наступлении времени напоминания (сейчас только виджет на дашборде).
2. **Поиск групп Telegram** по ключевым словам и **парсинг участников** выбранной группы — в бэклоге по конкуренту.
3. **Экспорт** контактов/лидов в CSV.
4. **Мультивыбор BD-аккаунтов** в одной кампании (распределение участников по агентам).
5. **AI:** подключение генерации персонализации, оптимального времени отправки, A/B вариантов при готовности AI Service.
6. При появлении обратной связи — **доработка UX условий шага** (например, чекбоксы этапов вместо multiselect, подсказки по полям).
