# ЭТАП 4 — Архитектура автосоздания сделки из лида

**Когда использовать:** после стабилизации ЭТАПА 3 и закрытия ЭТАПА 2 (stage_history нормализован, correlation_id в схеме).  
**Цель:** автоматически создавать сделку при определённых условиях (лид попал в стадию X), не создавая циклов, гонок и хаоса.  
**Детальный план (шаги, rule model, идемпотентность):** см. **STAGE_4_PLAN.md**.

---

## Чего не делать

**Опасно:** при попадании лида в стадию X сразу вызывать «создать сделку» в том же потоке/транзакции.

- Жёсткая связь «смена стадии → создание сделки» в одном месте приводит к циклам (сделка → обновление лида → снова триггер?) и сложной отладке.
- Нет единой точки принятия решения (правила, исключения, A/B).
- Сложно сделать идемпотентность и защиту от гонок в одном монолите.

---

## Правильная архитектура: событие → consumer → идемпотентное создание

1. **Смена стадии лида** обрабатывается как сейчас (Pipeline или CRM, в зависимости от владения лидом).
2. **Публикуется доменное событие** `lead.stage.changed` (leadId, pipelineId, fromStageId, toStageId, movedAt, …).
3. **Отдельный consumer** (worker / отдельный сервис) подписан на `lead.stage.changed`. Он:
   - решает по правилам организации, нужно ли создавать сделку (например, toStageId = «Готов к сделке»);
   - вызывает создание сделки через API: `POST /api/crm/deals` с `leadId` (и при необходимости остальными полями).
4. **Создание сделки идемпотентно:** уникальность по `lead_id` (partial unique index) гарантирует, что при повторной доставке события или двух одновременных сообщениях будет создана только одна сделка; второй запрос получит 409 и может быть проигнорирован или обработан как успех (уже создано).

Итог:

- Нет циклов: смена стадии только публикует событие; создание сделки — отдельный шаг.
- Единая точка создания сделки — CRM API; защита от дублей уже есть (409 при повторном leadId).
- Consumer можно менять (правила, отключение, несколько правил) без трогания кода смены стадии.

---

## Краткий чек-лист реализации ЭТАПА 4

- [ ] Событие `lead.stage.changed` публикуется при смене стадии лида (уже публикуется из pipeline-service).
- [ ] Consumer (automation-service) подписан на `LEAD_STAGE_CHANGED`; по правилам (pipeline_id, to_stage_id) решает — создавать сделку или нет.
- [ ] Создание сделки — вызов `POST /api/crm/deals` с `leadId`; 409 обрабатывать как «уже создано» (идемпотентность).
- [ ] Идемпотентность: запись в automation_executions + проверка «уже есть сделка по lead_id» перед вызовом; использовать correlation_id.
- [ ] Нет прямой связи «в коде смены стадии лида вызвать создание сделки» — только публикация события.

Полный план: **STAGE_4_PLAN.md**.
