# Архитектура: папки чатов, синхронизация, связь с CRM

## Цели

1. **Папки первым экраном** — пользователь видит только папки («Личное», «Все чаты», кастомные). Отмечает папки чекбоксами → подтягиваются и отображаются только чаты из этих папок.
2. **Непрерывная синхронизация** — подгрузка чатов из отмеченных папок не только при первой настройке, но и постоянно; новые чаты в уже отмеченной папке появляются в системе без повторной настройки.
3. **Связь CRM и чатов** — сделка создаётся на базе чата; минимальная модель: чат + сумма; чаты двигаются по воронке.

---

## 1. Модель данных

### 1.1 Папки (folders)

- **В Telegram:** встроенные «Все чаты» (folderId = 0 или главный список), «Архив» (1), плюс кастомные фильтры через `messages.getDialogFilters` (id = 2, 3, …).
- **У нас:** виртуальные папки для UI:
  - **«Личное»** — личные диалоги (можно реализовать как кастомный фильтр «Контакты» или через getDialogs без папки + фильтр по типу).
  - **«Все чаты»** — все диалоги (folderId = 0 / главный список).
  - **Кастомные папки** — из `getDialogFilters` (id и title).

### 1.2 Таблицы

- **bd_account_sync_folders** (новая)  
  Выбранные папки для синхронизации по аккаунту:
  - `bd_account_id`, `folder_id` (int: 0 = все чаты, 1 = архив, 2+ = id фильтра из Telegram; или строковый спец-код `personal` / `all`),
  - `folder_title` (название для UI),
  - `order_index` (порядок отображения).

- **bd_account_sync_chats** (существующая, расширяем)  
  Чаты, которые реально синкаем и показываем:
  - добавляем `folder_id` (nullable) — из какой папки попал чат;
  - логика: при выборе папок вызываем Telegram `getDialogs(folderId)` по каждой и обновляем sync_chats (добавляем/обновляем записи с folder_id).

- **deals** (расширяем)  
  Связь сделки с чатом:
  - `bd_account_id` (uuid, nullable),
  - `channel` (string, nullable, например `telegram`),
  - `channel_id` (string, nullable, telegram peer id).
  - Минимальная сделка «из чата»: чат + сумма (company/contact опционально или создаются автоматически).

---

## 2. Логика синхронизации

### 2.1 UX: выбор папок и контактов

- Во время настройки синхронизации пользователь видит **контакты, сгруппированные по папкам** (один и тот же контакт может быть в нескольких папках).
- Можно **выбрать папки** (чекбоксы) — тогда синкаются все контакты из этих папок.
- Дополнительно можно **выбрать отдельные контакты** (из любой папки или «Все чаты») — они добавляются в sync_chats даже если их папка не выбрана.
- Сохранение → POST `sync-folders` с `{ folders: [ { folderId, folderTitle } ], extraChats?: [ { id, name, isUser, isGroup, isChannel } ] }`.

### 2.2 Подгрузка чатов из папок

- При сохранении папок: для каждой выбранной папки вызвать `getDialogs({ folderId })`, по ответу заполнить/обновить `bd_account_sync_chats` (с указанием `folder_id`). Затем добавить в sync_chats все чаты из `extraChats` (если переданы).
- Постоянно: периодический вызов **sync-folders-refresh** или по открытию раздела сообщений — снова получить диалоги по выбранным папкам и добавить в sync_chats новые.
- **Входящие сообщения:** если чат **ещё не в sync_chats**, но у аккаунта есть выбранные папки — проверяем, входит ли этот чат в одну из папок (getDialogs по каждой папке). Если да — **автоматически добавляем чат в sync_chats**, сохраняем сообщение, публикуем событие и **в фоне подгружаем историю переписки** с этим контактом (syncHistoryForChat). Дальше все новые сообщения от этого контакта обрабатываются как обычно.

### 2.3 API (BD Accounts Service)

- **GET /api/bd-accounts/:id/folders** — список доступных папок: встроенные + `messages.getDialogFilters`. Возврат: `{ folders: [ { id, title, isCustom } ] }`.
- **GET /api/bd-accounts/:id/dialogs-by-folders** — диалоги, сгруппированные по папкам (для UI выбора контактов по папкам). Возврат: `{ folders: [ { id, title, dialogs: [ { id, name, isUser, isGroup, isChannel, ... } ] } ] }`. Один контакт может присутствовать в нескольких папках.
- **GET /api/bd-accounts/:id/sync-folders** — выбранные папки для синка (из `bd_account_sync_folders`).
- **POST /api/bd-accounts/:id/sync-folders** — сохранить выбранные папки и опционально отдельные контакты; body: `{ folders: [ { folderId, folderTitle } ], extraChats?: [ { id, name, isUser, isGroup, isChannel } ] }`. После сохранения — обновить чаты из папок (getDialogs по каждому folderId, merge в sync_chats) и добавить все чаты из `extraChats`.
- **POST /api/bd-accounts/:id/sync-folders-refresh** — принудительно обновить список чатов из выбранных папок (без смены выбора папок).
- **GET /api/bd-accounts/:id/sync-chats** — выбранные чаты для синка (в ответе есть `folder_id` для группировки по папкам).

Существующие эндпоинты sync-chats можно оставить для обратной совместимости или постепенно перевести UI на «только папки»; sync-start по-прежнему синкает историю по всем записям из sync_chats.

---

## 3. UI сообщений

- **Первый экран:** только папки с чекбоксами (Личное, Все чаты, кастомные). Кнопка «Сохранить и синхронизировать» → POST sync-folders, затем sync-start при необходимости.
- **После выбора папок:** в боковой панели показывать папки; при раскрытии папки — список чатов из этой папки (данные из БД по `folder_id` / sync_chats).
- **Скрывашка (collapse/expand):** все блоки (список аккаунтов, список папок/чатов) сворачиваются, кроме активного чата.

---

## 4. CRM и чаты

- **Создание сделки из чата:** в контексте чата кнопка «Создать сделку»; минимальная форма: чат (уже выбран) + сумма. В БД: `deals.bd_account_id`, `deals.channel`, `deals.channel_id` заполняются; company_id/contact_id опциональны или создаются по правилам (например, контакт из чата).
- **Воронка:** сделки, привязанные к чатам, двигаются по стадиям как обычно; в карточке сделки отображаем ссылку на чат и при необходимости быстрый переход в переписку.

---

## 5. Навигация

- В верхней навигации заменить «Дашборд» по умолчанию на «Сообщения» как основной раздел (или сделать Сообщения первым пунктом меню).

---

## 6. Этапы внедрения

1. Миграции: `bd_account_sync_folders`, `folder_id` в `bd_account_sync_chats`, поля чата в `deals`.
2. BD Accounts: реализация getDialogFilters + getDialogs(folderId), GET/POST sync-folders, refresh чатов из папок.
3. Messaging UI: экран выбора папок, отображение папок и чатов внутри них, collapse/expand.
4. CRM: создание сделки из чата (чат + сумма), отображение чата в сделке; при необходимости — доработка pipeline для «чатовых» сделок.
5. Навигация: «Сообщения» как основной раздел.

После этого архитектура будет соответствовать требованию: чаты — первичный объект, организованы через папки, синхронизируются постоянно и напрямую связаны с CRM и воронкой.
